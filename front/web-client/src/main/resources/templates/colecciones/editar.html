<!-- language: html -->
<!DOCTYPE html>
<html th:replace="~{layout/base :: html}"
      xmlns:th="http://www.thymeleaf.org"
      lang="es">

<section th:fragment="contenido">
    <div class="container mt-4">

        <h2>Editar colección</h2>

        <form th:action="@{|/colecciones/${coleccion.id}/editar|}"
              th:object="${coleccion}"
              method="post"
              onsubmit="return reindexCriterios()">

            <!-- ===================== -->
            <!-- DATOS BÁSICOS -->
            <!-- ===================== -->

            <div class="mb-3">
                <label class="form-label">Título</label>
                <input class="form-control" th:field="*{titulo}" required>
            </div>

            <div class="mb-3">
                <label class="form-label">Descripción</label>
                <textarea class="form-control"
                          th:field="*{descripcion}"
                          rows="3"
                          required></textarea>
            </div>

            <div class="mb-3">
                <label class="form-label">Algoritmo</label>
                <select class="form-select" th:field="*{algoritmo}">
                    <option value="SIMPLE">Simple</option>
                    <option value="ABSOLUTA">Mayoría absoluta</option>
                    <option value="MULTIPLE_MENCION">Múltiples menciones</option>
                    <option value="NINGUNO">Ninguno</option>
                </select>
            </div>

            <!-- ===================== -->
            <!-- FUENTES -->
            <!-- ===================== -->

            <div class="mb-3">
                <label class="form-label">Fuentes</label>

                <div class="form-check">
                    <input class="form-check-input"
                           type="checkbox"
                           th:field="*{fuentes}"
                           value="DATASET">
                    <label class="form-check-label">Dataset</label>
                </div>

                <div class="form-check">
                    <input class="form-check-input"
                           type="checkbox"
                           th:field="*{fuentes}"
                           value="PROXY">
                    <label class="form-check-label">Proxy</label>
                </div>

                <div class="form-check">
                    <input class="form-check-input"
                           type="checkbox"
                           th:field="*{fuentes}"
                           value="CONTRIBUYENTE">
                    <label class="form-check-label">Contribuyente</label>
                </div>
            </div>

            <!-- ===================== -->
            <!-- CRITERIOS -->
            <!-- ===================== -->

            <h5 class="mt-4">Criterios</h5>

            <div id="criterios-container">

                <div class="criterio border rounded p-3 mb-3"
                     th:each="criterio, stat : ${coleccion.criterios}">

                    <button type="button"
                            class="btn-close float-end"
                            onclick="this.closest('.criterio').remove()"></button>

                    <!-- TIPO (hidden obligatorio para Spring) -->
                    <input type="hidden"
                           th:name="'criterios[' + ${stat.index} + '].tipo'"
                           th:value="${criterio.tipo}">

                    <div class="mb-2">
                        <label class="form-label">Tipo</label>
                        <select class="form-select"
                                onchange="cambiarTipo(this)">
                            <option value="categoria"
                                    th:selected="${criterio.tipo == 'categoria'}">Categoría</option>
                            <option value="provincia"
                                    th:selected="${criterio.tipo == 'provincia'}">Provincia</option>
                            <option value="fecha"
                                    th:selected="${criterio.tipo == 'fecha'}">Fecha</option>
                        </select>
                    </div>

                    <!-- CATEGORIA -->
                    <div class="criterio-categoria campos" th:if="${criterio.tipo == 'categoria'}">
                        <label class="form-label">Categoría</label>
                        <select class="form-select"
                                th:name="'criterios[' + ${stat.index} + '].idCategoria'">
                            <option value="">Seleccione…</option>
                            <option th:each="cat : ${categorias}"
                                    th:value="${cat.id}"
                                    th:text="${cat.nombre}"
                                    th:selected="${criterio.categoria.id == cat.id}">
                            </option>
                        </select>
                    </div>

                    <!-- PROVINCIA -->
                    <div class="criterio-provincia campos" th:if="${criterio.tipo == 'provincia'}">
                        <label class="form-label">Provincia</label>
                        <input class="form-control"
                               th:name="'criterios[' + ${stat.index} + '].provincia'"
                               th:value="${criterio.provincia}">
                    </div>

                    <!-- FECHA -->
                    <div class="criterio-fecha campos" th:if="${criterio.tipo == 'fecha'}">
                        <label>Desde</label>
                        <input type="datetime-local"
                               class="form-control mb-2"
                               th:name="'criterios[' + ${stat.index} + '].fechaDesde'"
                               th:value="${criterio.fechaDesde}">

                        <label>Hasta</label>
                        <input type="datetime-local"
                               class="form-control"
                               th:name="'criterios[' + ${stat.index} + '].fechaHasta'"
                               th:value="${criterio.fechaHasta}">
                    </div>
                </div>
            </div>

            <button type="button"
                    class="btn btn-outline-primary btn-sm"
                    onclick="agregarCriterio()">
                + Agregar criterio
            </button>

            <!-- ===================== -->
            <!-- BOTONES -->
            <!-- ===================== -->

            <div class="mt-4 d-flex gap-2">
                <button class="btn btn-primary" type="submit">
                    Guardar cambios
                </button>
                <a th:href="@{/colecciones}" class="btn btn-outline-secondary">
                    Cancelar
                </a>
            </div>
        </form>
    </div>

    <!-- ===================== -->
    <!-- TEMPLATE -->
    <!-- ===================== -->

    <div id="criterio-template"
         class="criterio border rounded p-3 mb-3"
         style="display:none">

        <button type="button"
                class="btn-close float-end"
                onclick="this.closest('.criterio').remove()"></button>

        <input type="hidden" name="criterios[IDX].tipo" value="">

        <select class="form-select mb-2"
                onchange="cambiarTipo(this)">
            <option value="">Seleccione…</option>
            <option value="categoria">Categoría</option>
            <option value="provincia">Provincia</option>
            <option value="fecha">Fecha</option>
        </select>

        <div class="criterio-categoria campos" style="display:none">
            <select class="form-select"
                    name="criterios[IDX].idCategoria">
                <option value="">Seleccione…</option>
                <option th:each="cat : ${categorias}"
                        th:value="${cat.id}"
                        th:text="${cat.nombre}">
                </option>
            </select>
        </div>

        <div class="criterio-provincia campos" style="display:none">
            <input class="form-control"
                   name="criterios[IDX].provincia">
        </div>

        <div class="criterio-fecha campos" style="display:none">
            <input type="datetime-local"
                   class="form-control mb-2"
                   name="criterios[IDX].fechaDesde">
            <input type="datetime-local"
                   class="form-control"
                   name="criterios[IDX].fechaHasta">
        </div>
    </div>

    <!-- ===================== -->
    <!-- JS -->
    <!-- ===================== -->

    <script>
        let criterioIndex = [[${coleccion.criterios != null ? coleccion.criterios.size() : 0}]];

        function agregarCriterio() {
            const template = document.getElementById("criterio-template");
            const clone = template.cloneNode(true);
            clone.style.display = "block";
            clone.innerHTML = clone.innerHTML.replaceAll("IDX", criterioIndex);
            document.getElementById("criterios-container").appendChild(clone);
            criterioIndex++;
        }

        function cambiarTipo(select) {
            const card = select.closest(".criterio");
            const hidden = card.querySelector("input[type='hidden'][name*='.tipo']");
            if (hidden) hidden.value = select.value;

            card.querySelectorAll(".campos").forEach(c => c.style.display = "none");

            if (select.value === "categoria") {
                const el = card.querySelector(".criterio-categoria");
                if (el) el.style.display = "block";
            }
            if (select.value === "provincia") {
                const el = card.querySelector(".criterio-provincia");
                if (el) el.style.display = "block";
            }
            if (select.value === "fecha") {
                const el = card.querySelector(".criterio-fecha");
                if (el) el.style.display = "block";
            }
        }

        // Reindexa los nombres de los inputs de criterios antes de enviar el formulario.
        function reindexCriterios() {
            const container = document.getElementById("criterios-container");
            const criterios = container.querySelectorAll(".criterio");
            criterios.forEach((card, idx) => {
                // hidden tipo
                const hidden = card.querySelector("input[type='hidden'][name*='.tipo']");
                if (hidden) hidden.name = `criterios[${idx}].tipo`;

                // categoría
                const catSelect = card.querySelector(".criterio-categoria select");
                if (catSelect) catSelect.name = `criterios[${idx}].idCategoria`;

                // provincia
                const provInput = card.querySelector(".criterio-provincia input");
                if (provInput) provInput.name = `criterios[${idx}].provincia`;

                // fecha desde / hasta
                const fechaDesde = card.querySelector(".criterio-fecha input[name*='fechaDesde']");
                if (fechaDesde) fechaDesde.name = `criterios[${idx}].fechaDesde`;
                const fechaHasta = card.querySelector(".criterio-fecha input[name*='fechaHasta']");
                if (fechaHasta) fechaHasta.name = `criterios[${idx}].fechaHasta`;
            });

            // actualización del índice global (por si se añade tras submit fallido)
            criterioIndex = criterios.length;
            return true; // permitir submit
        }
    </script>

</section>
</html>
