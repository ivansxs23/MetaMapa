<section th:fragment="solicitudes" class="col-12">
    <div class="card p-3">
    <h2>Solicitudes</h2>
        <form th:action="@{/panel}" th:object="${filtro}" method="post" class="mb-3">

            <!-- Fila de filtros -->
            <div class="row g-2">
                <div class="col-md-2">
                    <select class="form-select" name="tipo">
                        <option value="">Tipo (todos)</option>
                        <option value="CREACION" th:selected="${filtro.tipo?.name()=='CREACION'}">Creación</option>
                        <option value="EDICION" th:selected="${filtro.tipo?.name()=='EDICION'}">Edición</option>
                        <option value="ELIMINACION" th:selected="${filtro.tipo?.name()=='ELIMINACION'}">Eliminación</option>
                    </select>
                </div>

                <div class="col-md-2">
                    <select class="form-select" name="estado">
                        <option value="">Estado (todos)</option>
                        <option value="PENDIENTE" th:selected="${filtro.estado?.name()=='PENDIENTE'}">Pendiente</option>
                        <option value="APROBADA" th:selected="${filtro.estado?.name()=='APROBADA'}">Aprobada</option>
                        <option value="DENEGADA" th:selected="${filtro.estado?.name()=='DENEGADA'}">Rechazada</option>
                    </select>
                </div>

                <div class="col-md-2">
                    <input class="form-control" name="solicitante" placeholder="Solicitante"
                           th:value="${filtro.solicitante}">
                </div>

                <div class="col-md-2">
                    <input class="form-control" name="administrador" placeholder="Administrador"
                           th:value="${filtro.administrador}">
                </div>
            </div>

            <!-- Fila de acciones -->
            <div class="row g-2 mt-2">
                <div class="col-md-2 d-grid">
                    <button class="btn btn-primary" type="submit">Filtrar</button>
                </div>

                <div class="col-md-2 d-grid">
                    <a class="btn btn-outline-secondary" th:href="@{/panel}">Limpiar</a>
                </div>
            </div>

        </form>

        <table class="table table-striped align-middle">
            <thead>
            <tr>
                <th>ID</th>
                <th>Tipo</th>
                <th>Estado</th>
                <th>Solicitante</th>
                <th>Administrador</th>
                <th>Creación</th>
                <th>Resolución</th>
                <th class="text-end">Acciones</th>
            </tr>
            </thead>

            <tbody>
            <tr th:each="s : ${solicitudes}">
                <td th:text="${s.id}">1</td>
                <td th:text="${s.tipo}">CREACION</td>
                <td th:text="${s.estado}">PENDIENTE</td>
                <td th:text="${s.solicitante}">Solicitante</td>
                <td th:text="${s.administrador != null ? s.administrador : '-'}">-</td>
                <td th:text="${s.fechaCreacion != null ? #temporals.format(s.fechaCreacion,'dd/MM/yyyy HH:mm') : '-'}">-</td>
                <td th:text="${s.fechaResolucion != null ? #temporals.format(s.fechaResolucion,'dd/MM/yyyy HH:mm') : '-'}">-</td>

                <td class="text-end">
                    <button type="button"
                            class="btn btn-secondary btn-sm btn-ver-detalle"
                            data-bs-toggle="modal" data-bs-target="#modalHecho"
                            th:attr="
                  data-tipo=${s.tipo},


                  data-nuevo-titulo=${s.datosNuevos?.titulo},
                  data-nuevo-descripcion=${s.datosNuevos?.descripcion},
                  data-nuevo-fecha=${s.datosNuevos?.fechaAcontecimiento},
                  data-nuevo-categoria=${s.datosNuevos?.idCategoria},
                  data-nuevo-latitud=${s.datosNuevos?.latitud},
                  data-nuevo-longitud=${s.datosNuevos?.longitud},
                  data-nuevo-anonimo=${s.datosNuevos?.esAnonimo},


                  data-actual-titulo=${s.hecho?.titulo},
                  data-actual-descripcion=${s.hecho?.descripcion},
                  data-actual-fecha=${s.hecho?.fechaAcontecimiento},
                  data-actual-categoria=${s.hecho?.categoria?.id},
                  data-actual-latitud=${s.hecho?.latitud},
                  data-actual-longitud=${s.hecho?.longitud},
                  data-actual-anonimo=${s.hecho?.esAnonimo},


                  data-motivo=${s.motivo},
                  data-esspam=${s.esSpam}
                ">
                        Ver detalle
                    </button>

                    <a th:href="@{|/solicitudes/${s.id}/aprobar|}" class="btn btn-success btn-sm"
                       th:if="${s.estado.name() == 'PENDIENTE'}">Aprobar</a>

                    <a th:href="@{|/solicitudes/${s.id}/denegar|}" class="btn btn-danger btn-sm"
                       th:if="${s.estado.name() == 'PENDIENTE'}">Rechazar</a>
                </td>
            </tr>

            <tr th:if="${#lists.isEmpty(solicitudes)}">
                <td colspan="8" class="text-center text-muted py-4">No hay solicitudes</td>
            </tr>
            </tbody>
        </table>

    </div>

    <div class="modal fade" id="modalHecho" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalHechoTitle">Detalle</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>

                <div class="modal-body">
                    <!-- CREACION: detalle simple -->
                    <div id="modalModoCreacion" class="d-none">
                        <dl class="row mb-0">
                            <dt class="col-sm-4">Título</dt><dd class="col-sm-8" id="m_titulo"></dd>
                            <dt class="col-sm-4">Descripción</dt><dd class="col-sm-8" id="m_desc"></dd>
                            <dt class="col-sm-4">Categoría</dt><dd class="col-sm-8" id="m_cat"></dd>
                            <dt class="col-sm-4">Fecha acontecimiento</dt><dd class="col-sm-8" id="m_fecha"></dd>
                            <dt class="col-sm-4">Ubicacion</dt><dd class="col-sm-8" id="m_ubicacion"></dd>
                            <dt class="col-sm-4">Anónimo</dt><dd class="col-sm-8" id="m_anon"></dd>
                        </dl>
                    </div>

                    <!-- EDICION: tabla comparativa -->
                    <div id="modalModoEdicion" class="d-none">
                        <div class="table-responsive">
                            <table class="table table-sm align-middle">
                                <thead>
                                <tr>
                                    <th>Campo</th>
                                    <th>Actual</th>
                                    <th>Nuevo</th>
                                </tr>
                                </thead>
                                <tbody id="diffBody"></tbody>
                            </table>
                        </div>
                        <div class="small text-muted">Los campos distintos se resaltan.</div>
                    </div>
                </div>

                <!-- ELIMINACION: detalle -->
                <div id="modalModoEliminacion" class="d-none">
                    <dl class="row mb-0">
                        <dt class="col-sm-4">Hecho</dt><dd class="col-sm-8" id="del_titulo"></dd>
                        <dt class="col-sm-4">Motivo</dt><dd class="col-sm-8" id="del_motivo"></dd>
                        <dt class="col-sm-4">Es spam</dt><dd class="col-sm-8" id="del_spam"></dd>
                    </dl>
                </div>


                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
</section>

