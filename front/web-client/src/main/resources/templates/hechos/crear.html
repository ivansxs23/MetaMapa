<html th:replace="~{layout/base :: html}" lang="es" xmlns:th="http://www.thymeleaf.org">
<div class="col-md-6" th:fragment="contenido">
    <div class="card p-4">
        <h3>Nuevo hecho</h3>
        <form th:action="@{/hechos/crear}" th:object="${hecho}" method="post" enctype="multipart/form-data">

            <!-- T√≠tulo -->
            <div class="mb-3">
                <label for="c-titulo" class="form-label">T√≠tulo *</label>
                <input id="c-titulo" th:field="*{titulo}" class="form-control" th:classappend="${#fields.hasErrors('titulo')}" required placeholder="Descripci√≥n breve" />
                <div th:if="${#fields.hasErrors('titulo')}" class="text-danger">
                    <small th:errors="*{titulo}">Error en titulo</small>
                </div>
            </div>

            <!-- Descripci√≥n -->
            <div class="mb-3">
                <label for="c-desc" class="form-label">Descripci√≥n *</label>
                <textarea id="c-desc" th:field="*{descripcion}" class="form-control" th:classappend="${#fields.hasErrors('descripcion')}" rows="3" required placeholder="Detalles, contexto y observaciones"></textarea>
                <div th:if="${#fields.hasErrors('descripcion')}" class="text-danger">
                    <small th:errors="*{descripcion}">Error en descripcion</small>
                </div>
            </div>

            <div class="row">
                <!-- Categor√≠a -->
                <div class="col-md-6 mb-3">
                    <label for="categoria" class="form-label">Categor√≠a *</label>
                    <select id="categoria" th:field="*{idCategoria}" class="form-select" th:classappend="${#fields.hasErrors('idCategoria')}" required>
                        <option th:value="null">Seleccione</option>
                        <option th:each="c : ${categorias}" th:value="${c.id}" th:text="${c.nombre}">Categoria</option>
                    </select>
                    <div th:if="${#fields.hasErrors('idCategoria')}" class="text-danger">
                        <small th:errors="*{idCategoria}">Error en idCategoria</small>
                    </div>
                </div>

                <!-- Fecha -->
                <div class="col-md-6 mb-3">
                    <label for="c-fecha" class="form-label">Fecha *</label>
                    <input id="c-fecha" type="datetime-local" th:field="*{fechaAcontecimiento}" class="form-control" th:classappend="${#fields.hasErrors('fechaAcontecimiento')}" required />
                    <div th:if="${#fields.hasErrors('fechaAcontecimiento')}" class="text-danger">
                        <small th:errors="*{fechaAcontecimiento}">Error en fechaAcontecimiento</small>
                    </div>
                </div>
            </div>
            <div class="mb-3">
                <!-- Mapa (en ratio para mantener altura/anchura) -->
                <div class="card mb-3">
                    <div class="card-body p-0">
                        <div class="ratio ratio-16x9">
                            <div th:replace="visualizar/visualizador_map :: mapa"></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Campos de coordenadas -->
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="c-lat" class="form-label">Latitud *</label>
                    <input id="c-lat" type="number" step="any" th:field="*{latitud}" class="form-control" th:classappend="${#fields.hasErrors('latitud')}" placeholder="-34.6037"  required />
                    <div th:if="${#fields.hasErrors('latitud')}" class="text-danger">
                        <small th:errors="*{latitud}">Error en latitud</small>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="c-long" class="form-label">Longitud *</label>
                    <input id="c-long" type="number" step="any" th:field="*{longitud}" class="form-control" th:classappend="${#fields.hasErrors('longitud')}" placeholder="-58.3816"  required/>
                    <div th:if="${#fields.hasErrors('longitud')}" class="text-danger">
                        <small th:errors="*{longitud}">Error en longitud</small>
                    </div>
                </div>
            </div>

            <div class="form-check" th:if ="${#authentication.principal != 'anonymousUser'}">
                <input class="form-check-input" type="checkbox" th:field="*{esAnonimo}" th:classappend="${#fields.hasErrors('esAnonimo')}" id="flexCheckDefault">
                <label class="form-check-label" for="flexCheckDefault">¬øDesea mantener su informaci√≥n personal oculta?</label>
                <div th:if="${#fields.hasErrors('esAnonimo')}" class="text-danger">
                    <small th:errors="*{esAnonimo}">Error en esAnonimo</small>
                </div>
            </div>

            <!-- Multimedia -->
            <div class="col-md-6 mb-3">
                <label for="c-media" class="form-label">Multimedia</label>
                <input id="c-media" type="file" name="files" class="form-control" accept="image/*,video/*" multiple />
                <div class="form-text">
                    Se aceptan im√°genes y videos. Tama√±o m√°ximo: 25MB.
                </div>
            </div>
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary" >Enviar</button>
                <button type="reset" class="btn btn-outline-secondary">Limpiar</button>
            </div>

        </form>
    </div>
</div>
</html>
<script th:inline="javascript">
    /*<![CDATA[*/

    // üß≠ Inicializa el mapa centrado en Buenos Aires
    console.log("‚úÖ app.js cargado");

    var map = L.map('map').setView([-34.6037, -58.3816], 5);

    // üó∫Ô∏è Capa base (OpenStreetMap)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    var marker;

    map.on('click', function (e) {
        var lat = e.latlng.lat.toFixed(6);
        var lng = e.latlng.lng.toFixed(6);

        // Setear inputs
        document.getElementById('c-lat').value = lat;
        document.getElementById('c-long').value = lng;

        // Marker √∫nico
        if (marker) {
            marker.setLatLng(e.latlng);
        } else {
            marker = L.marker(e.latlng).addTo(map);
        }
    });

    /*]]>*/
</script>
